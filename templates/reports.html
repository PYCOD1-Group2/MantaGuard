{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block extra_css %}
<style>
    /* Professional cybersecurity themed variables */
    :root {
        --cyber-primary: #4CAF50;
        --cyber-secondary: #2196F3;
        --cyber-accent: #F44336;
        --cyber-warning: #FF9800;
        --cyber-success: #4CAF50;
        --cyber-bg-dark: #121212;
        --cyber-bg-card: #1e1e1e;
        --cyber-bg-hover: #2a2a2a;
        --cyber-border: rgba(255, 255, 255, 0.12);
        --cyber-border-accent: rgba(76, 175, 80, 0.3);
        --cyber-text: #ffffff;
        --cyber-text-secondary: #b0b0b0;
        --cyber-text-dim: #757575;
        --cyber-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        --cyber-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    /* Override global background */
    body {
        background: var(--cyber-bg-dark);
    }

    /* Professional metric cards */
    .metric-card {
        background: var(--cyber-bg-card);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        border: 1px solid var(--cyber-border);
        transition: all 0.3s ease;
        height: 100%;
        box-shadow: var(--cyber-shadow);
    }
    
    .metric-card:hover {
        border-color: var(--cyber-border-accent);
        transform: translateY(-2px);
        box-shadow: var(--cyber-shadow-hover);
        background: var(--cyber-bg-hover);
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--cyber-primary);
        margin-bottom: 8px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
    
    .metric-label {
        color: var(--cyber-text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    /* Professional cards */
    .card {
        background: var(--cyber-bg-card);
        border: 1px solid var(--cyber-border);
        border-radius: 8px;
        box-shadow: var(--cyber-shadow);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        border-color: var(--cyber-border-accent);
        box-shadow: var(--cyber-shadow-hover);
    }
    
    .card-header {
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--cyber-border);
        padding: 20px;
        border-radius: 8px 8px 0 0 !important;
    }
    
    .card-header h5 {
        color: var(--cyber-text);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
        font-size: 0.9rem;
    }
    
    /* Professional timeline */
    .scan-timeline {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .scan-timeline::-webkit-scrollbar {
        width: 6px;
    }
    
    .scan-timeline::-webkit-scrollbar-track {
        background: var(--cyber-bg-dark);
        border-radius: 3px;
    }
    
    .scan-timeline::-webkit-scrollbar-thumb {
        background: var(--cyber-text-dim);
        border-radius: 3px;
    }
    
    .scan-timeline::-webkit-scrollbar-thumb:hover {
        background: var(--cyber-primary);
    }
    
    .timeline-item {
        border-left: 3px solid var(--cyber-primary);
        padding-left: 20px;
        margin-bottom: 16px;
        position: relative;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 0 6px 6px 0;
        padding: 12px 16px 12px 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 12px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--cyber-primary);
        border: 2px solid var(--cyber-bg-dark);
    }
    
    .timeline-item.high-severity {
        border-left-color: var(--cyber-accent);
        background: rgba(244, 67, 54, 0.05);
    }
    
    .timeline-item.high-severity::before {
        background-color: var(--cyber-accent);
    }
    
    .timeline-item.medium-severity {
        border-left-color: var(--cyber-warning);
        background: rgba(255, 152, 0, 0.05);
    }
    
    .timeline-item.medium-severity::before {
        background-color: var(--cyber-warning);
    }
    
    /* Professional protocol bars */
    .protocol-bar {
        background: var(--cyber-bg-dark);
        height: 20px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
        position: relative;
        border: 1px solid var(--cyber-border);
    }
    
    .protocol-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--cyber-primary), var(--cyber-secondary));
        transition: width 0.3s ease;
    }
    
    .protocol-label {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.75rem;
        color: var(--cyber-text);
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }
    
    /* Professional severity badges */
    .severity-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid;
    }
    
    .severity-high {
        background: rgba(244, 67, 54, 0.1);
        color: var(--cyber-accent);
        border-color: var(--cyber-accent);
    }
    
    .severity-medium {
        background: rgba(255, 152, 0, 0.1);
        color: var(--cyber-warning);
        border-color: var(--cyber-warning);
    }
    
    .severity-low {
        background: rgba(76, 175, 80, 0.1);
        color: var(--cyber-primary);
        border-color: var(--cyber-primary);
    }
    
    /* Professional scan items */
    .scan-item {
        background: var(--cyber-bg-card);
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 8px;
        border: 1px solid var(--cyber-border);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .scan-item:hover {
        border-color: var(--cyber-border-accent);
        background: var(--cyber-bg-hover);
        transform: translateX(2px);
        box-shadow: var(--cyber-shadow);
    }
    
    /* Professional buttons */
    .btn-outline-primary {
        color: var(--cyber-primary);
        border-color: var(--cyber-primary);
        background: transparent;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-outline-primary:hover {
        background-color: var(--cyber-primary);
        border-color: var(--cyber-primary);
        color: var(--cyber-bg-dark);
    }
    
    .btn-primary {
        background: var(--cyber-primary);
        border: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background: #45a049;
        transform: translateY(-1px);
        box-shadow: var(--cyber-shadow);
    }
    
    /* Professional refresh button - scoped to reports page only */
    .container-fluid .refresh-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--cyber-border);
        border-radius: 6px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--cyber-text-secondary);
    }
    
    .container-fluid .refresh-btn:hover {
        background: var(--cyber-bg-hover);
        color: var(--cyber-primary);
        border-color: var(--cyber-border-accent);
    }
    
    /* Professional loading spinner */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner-border {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: var(--cyber-primary);
    }
    
    /* Professional anomaly rate styling */
    .anomaly-rate-high {
        color: var(--cyber-accent);
        font-weight: 600;
    }
    
    .anomaly-rate-medium {
        color: var(--cyber-warning);
        font-weight: 600;
    }
    
    .anomaly-rate-low {
        color: var(--cyber-primary);
        font-weight: 600;
    }
    
    /* Professional headings */
    h1, h5, h6 {
        color: var(--cyber-text);
    }
    
    h1 {
        font-weight: 700;
        color: var(--cyber-text);
    }
    
    /* Professional table styling for modal */
    .table-dark {
        background: var(--cyber-bg-card);
        border: 1px solid var(--cyber-border);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .table-dark th {
        background: rgba(255, 255, 255, 0.03);
        color: var(--cyber-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-color: var(--cyber-border);
        font-size: 0.8rem;
    }
    
    .table-dark td {
        border-color: var(--cyber-border);
        color: var(--cyber-text);
    }
    
    .table-dark tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    
    /* Professional checkbox styling */
    input[type="checkbox"] {
        accent-color: var(--cyber-primary);
        transform: scale(1.1);
    }
    
    /* Professional form switch styling */
    .form-check-input:checked {
        background-color: var(--cyber-primary);
        border-color: var(--cyber-primary);
    }
    
    .form-check-label {
        color: var(--cyber-text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* Professional Toast Styling */
    .toast-container {
        z-index: 1060;
    }
    
    .toast {
        background: var(--cyber-bg-card);
        border: 1px solid var(--cyber-border);
        border-radius: 8px;
        box-shadow: var(--cyber-shadow-hover);
        backdrop-filter: blur(8px);
        min-width: 350px;
    }
    
    .toast.border-success {
        border-color: var(--cyber-primary);
        border-left: 4px solid var(--cyber-primary);
    }
    
    .toast.border-danger {
        border-color: var(--cyber-accent);
        border-left: 4px solid var(--cyber-accent);
    }
    
    .toast-header {
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--cyber-border);
        color: var(--cyber-text);
        font-weight: 600;
        border-radius: 8px 8px 0 0;
    }
    
    .toast-body {
        color: var(--cyber-text);
        padding: 16px;
        font-weight: 400;
    }
    
    .toast-body code {
        background: rgba(255, 255, 255, 0.05);
        color: var(--cyber-primary);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        border: 1px solid var(--cyber-border);
        font-size: 0.85em;
    }
    
    .btn-close {
        filter: invert(1) brightness(0.8);
    }
    
    /* Text color overrides */
    .text-muted {
        color: var(--cyber-text-dim) !important;
    }
    
    /* Professional tab styling for visualizations */
    .nav-tabs {
        border-bottom: 1px solid var(--cyber-border);
    }
    
    .nav-tabs .nav-link {
        background: transparent;
        border: 1px solid transparent;
        color: var(--cyber-text-secondary);
        font-weight: 500;
        padding: 8px 16px;
        margin-right: 2px;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--cyber-text);
        border-color: var(--cyber-border);
    }
    
    .nav-tabs .nav-link.active {
        background: var(--cyber-bg-card);
        color: var(--cyber-primary);
        border-color: var(--cyber-border) var(--cyber-border) var(--cyber-bg-card);
        border-bottom-color: var(--cyber-bg-card);
    }
    
    .tab-content {
        border: 1px solid var(--cyber-border);
        border-top: none;
        border-radius: 0 6px 6px 6px;
        background: var(--cyber-bg-card);
        min-height: 400px;
    }
    
    .tab-pane {
        padding: 20px;
    }
    
    .visualization-container {
        text-align: center;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .visualization-container img {
        max-width: 100%;
        max-height: 350px;
        object-fit: contain;
        border-radius: 4px;
        box-shadow: var(--cyber-shadow);
    }
    
    .no-visualization {
        color: var(--cyber-text-dim);
        font-style: italic;
        text-align: center;
        padding: 60px 20px;
    }
    
    /* Professional badge styling */
    .badge {
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .bg-danger {
        background: var(--cyber-accent) !important;
    }
    
    .bg-success {
        background: var(--cyber-primary) !important;
    }
    
    /* Professional modal styling */
    .modal-content {
        background: var(--cyber-bg-card) !important;
        border: 1px solid var(--cyber-border) !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4) !important;
        border-radius: 8px !important;
    }
    
    .modal-header {
        border-bottom: 1px solid var(--cyber-border) !important;
        background: rgba(255, 255, 255, 0.02) !important;
        border-radius: 8px 8px 0 0 !important;
    }
    
    .modal-title {
        color: var(--cyber-text) !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-chart-bar me-2"></i>Security Reports & Analytics</h1>
                <button class="btn btn-outline-primary refresh-btn" onclick="refreshReports()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading analytics data...</p>
    </div>

    <!-- Main Content -->
    <div id="reports-content">
        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-number" id="total-scans">{{ analytics.total_scans }}</div>
                    <div class="metric-label">Total Scans</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-number" id="total-connections">{{ analytics.total_connections }}</div>
                    <div class="metric-label">Connections Analyzed</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-number" id="anomaly-count" style="color: #dc3545;">{{ analytics.anomaly_count }}</div>
                    <div class="metric-label">Anomalies Detected</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-number" id="anomaly-rate" style="color: #ffc107;">{{ analytics.network_activity.anomaly_rate }}%</div>
                    <div class="metric-label">Anomaly Rate</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Protocol Distribution -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-network-wired me-2"></i>Protocol Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="protocol-chart">
                            {% if analytics.protocol_distribution %}
                                {% set total_protocols = analytics.protocol_distribution.values() | sum %}
                                {% for protocol, count in analytics.protocol_distribution.items() %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small>{{ protocol.upper() }}</small>
                                        <small>{{ count }} ({{ "%.1f"|format((count / total_protocols * 100) if total_protocols > 0 else 0) }}%)</small>
                                    </div>
                                    <div class="protocol-bar">
                                        <div class="protocol-fill" style="width: {{ (count / total_protocols * 100) if total_protocols > 0 else 0 }}%"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No protocol data available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threat Timeline -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Recent Threats</h5>
                    </div>
                    <div class="card-body">
                        <div class="scan-timeline" id="threat-timeline">
                            {% if analytics.threat_timeline %}
                                {% for threat in analytics.threat_timeline %}
                                <div class="timeline-item {{ threat.severity }}-severity">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ threat.threat_count }} Anomalies</strong>
                                            <br><small class="text-muted">{{ threat.timestamp }}</small>
                                        </div>
                                        <span class="severity-badge severity-{{ threat.severity }}">{{ threat.severity }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No recent threats detected</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Scans -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Recent Scan History</h5>
                    </div>
                    <div class="card-body">
                        <div id="recent-scans">
                            {% if analytics.recent_scans %}
                                {% for scan in analytics.recent_scans %}
                                <div class="scan-item" onclick="viewScanDetails('{{ scan.directory }}')">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <strong>{{ scan.timestamp }}</strong>
                                        </div>
                                        <div class="col-md-2">
                                            <i class="fas fa-link me-1"></i>{{ scan.connections }} connections
                                        </div>
                                        <div class="col-md-2">
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ scan.anomalies }} anomalies
                                        </div>
                                        <div class="col-md-2">
                                            <span class="anomaly-rate-{% if scan.anomaly_rate > 50 %}high{% elif scan.anomaly_rate > 20 %}medium{% else %}low{% endif %}">
                                                {{ scan.anomaly_rate }}% anomaly rate
                                            </span>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Scan History</h5>
                                    <p class="text-muted">Run your first network scan to see analytics here.</p>
                                    <a href="{{ url_for('scanning') }}" class="btn btn-primary">
                                        <i class="fas fa-radar-chart me-2"></i>Start Scanning
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060">
    <div id="extractionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-download me-2 text-primary"></i>
            <strong class="me-auto">PCAP Extraction</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
            <!-- Toast message will be set dynamically -->
        </div>
    </div>
</div>

<!-- Scan Details Modal -->
<div class="modal fade" id="scanDetailsModal" tabindex="-1">
    <div class="modal-dialog" style="max-width: 95vw; width: 95vw;">
        <div class="modal-content" style="background-color: #1E1E1E; border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h5 class="modal-title" id="scanDetailsTitle">Scan Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scanDetailsBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshReports() {
    const loadingSpinner = document.getElementById('loading-spinner');
    const reportsContent = document.getElementById('reports-content');
    
    loadingSpinner.style.display = 'block';
    reportsContent.style.opacity = '0.5';
    
    fetch('/api/reports/analytics')
    .then(response => response.json())
    .then(data => {
        updateMetrics(data);
        updateProtocolChart(data.protocol_distribution);
        updateThreatTimeline(data.threat_timeline);
        updateRecentScans(data.recent_scans);
        
        loadingSpinner.style.display = 'none';
        reportsContent.style.opacity = '1';
    })
    .catch(error => {
        console.error('Error refreshing reports:', error);
        loadingSpinner.style.display = 'none';
        reportsContent.style.opacity = '1';
    });
}

function updateMetrics(data) {
    document.getElementById('total-scans').textContent = data.total_scans;
    document.getElementById('total-connections').textContent = data.total_connections;
    document.getElementById('anomaly-count').textContent = data.anomaly_count;
    document.getElementById('anomaly-rate').textContent = data.network_activity.anomaly_rate + '%';
}

function updateProtocolChart(protocolData) {
    const chartContainer = document.getElementById('protocol-chart');
    const total = Object.values(protocolData).reduce((sum, count) => sum + count, 0);
    
    let html = '';
    for (const [protocol, count] of Object.entries(protocolData)) {
        const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
        html += `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <small>${protocol.toUpperCase()}</small>
                    <small>${count} (${percentage}%)</small>
                </div>
                <div class="protocol-bar">
                    <div class="protocol-fill" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    }
    
    if (html === '') {
        html = '<p class="text-muted">No protocol data available</p>';
    }
    
    chartContainer.innerHTML = html;
}

function updateThreatTimeline(threats) {
    const timelineContainer = document.getElementById('threat-timeline');
    
    let html = '';
    threats.forEach(threat => {
        html += `
            <div class="timeline-item ${threat.severity}-severity">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${threat.threat_count} Anomalies</strong>
                        <br><small class="text-muted">${threat.timestamp}</small>
                    </div>
                    <span class="severity-badge severity-${threat.severity}">${threat.severity}</span>
                </div>
            </div>
        `;
    });
    
    if (html === '') {
        html = '<p class="text-muted">No recent threats detected</p>';
    }
    
    timelineContainer.innerHTML = html;
}

function updateRecentScans(scans) {
    const scansContainer = document.getElementById('recent-scans');
    
    let html = '';
    scans.forEach(scan => {
        const severityClass = scan.anomaly_rate > 50 ? 'high' : scan.anomaly_rate > 20 ? 'medium' : 'low';
        html += `
            <div class="scan-item" onclick="viewScanDetails('${scan.directory}')">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <strong>${scan.timestamp}</strong>
                    </div>
                    <div class="col-md-2">
                        <i class="fas fa-link me-1"></i>${scan.connections} connections
                    </div>
                    <div class="col-md-2">
                        <i class="fas fa-exclamation-circle me-1"></i>${scan.anomalies} anomalies
                    </div>
                    <div class="col-md-2">
                        <span class="anomaly-rate-${severityClass}">
                            ${scan.anomaly_rate}% anomaly rate
                        </span>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View Details
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    if (html === '') {
        html = `
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Scan History</h5>
                <p class="text-muted">Run your first network scan to see analytics here.</p>
                <a href="/scanning" class="btn btn-primary">
                    <i class="fas fa-radar-chart me-2"></i>Start Scanning
                </a>
            </div>
        `;
    }
    
    scansContainer.innerHTML = html;
}

function viewScanDetails(scanId) {
    const modal = new bootstrap.Modal(document.getElementById('scanDetailsModal'));
    const modalTitle = document.getElementById('scanDetailsTitle');
    const modalBody = document.getElementById('scanDetailsBody');
    
    modalTitle.textContent = `Scan Details - ${scanId}`;
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    fetch(`/api/reports/scan/${scanId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        // Generate visualization tabs
        const vizTabs = data.visualizations.length > 0 ? 
            data.visualizations.map((viz, index) => {
                const vizName = viz.replace('.png', '').replace(/_/g, ' ');
                const isActive = index === 0 ? 'active' : '';
                return `<li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" id="viz-${index}-tab" data-bs-toggle="tab" data-bs-target="#viz-${index}" type="button" role="tab">
                        ${vizName}
                    </button>
                </li>`;
            }).join('') : 
            '<li class="nav-item"><span class="nav-link disabled">No Visualizations</span></li>';

        const vizContent = data.visualizations.length > 0 ? 
            data.visualizations.map((viz, index) => {
                const isActive = index === 0 ? 'show active' : '';
                return `<div class="tab-pane fade ${isActive}" id="viz-${index}" role="tabpanel">
                    <div class="visualization-container">
                        <img src="/images/${viz}" alt="${viz}" loading="lazy" />
                    </div>
                </div>`;
            }).join('') : 
            '<div class="tab-pane fade show active"><div class="no-visualization">No visualizations available for this scan</div></div>';

        modalBody.innerHTML = `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-number">${data.total_connections}</div>
                        <div class="metric-label">Total Connections</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-number" style="color: #dc3545;">${data.anomalies}</div>
                        <div class="metric-label">Anomalies</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-number" style="color: #28a745;">${data.normal}</div>
                        <div class="metric-label">Normal</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-number" style="color: #ffc107;">${data.anomaly_rate}%</div>
                        <div class="metric-label">Anomaly Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Connection Details</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="anomalyFilter" onchange="filterConnections('${scanId}')">
                            <label class="form-check-label" for="anomalyFilter">
                                Show only anomalies
                            </label>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th width="40px">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll('${scanId}')">
                                    </th>
                                    <th>UID</th>
                                    <th>Protocol</th>
                                    <th>Score</th>
                                    <th>Prediction</th>
                                </tr>
                            </thead>
                            <tbody id="connectionsTableBody">
                                ${data.connections.map(conn => `
                                    <tr data-prediction="${conn.prediction}">
                                        <td><input type="checkbox" class="connection-checkbox" value="${conn.uid}"></td>
                                        <td>${conn.uid}</td>
                                        <td>${conn.proto || 'unknown'}</td>
                                        <td>${parseFloat(conn.score).toFixed(4)}</td>
                                        <td><span class="badge ${conn.prediction === 'anomaly' ? 'bg-danger' : 'bg-success'}">${conn.prediction}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="extractSelectedConnections('${scanId}')" id="extractBtn" disabled>
                            <i class="fas fa-download me-1"></i>Extract Selected PCAPs
                        </button>
                        <span class="ms-2 text-muted" id="selectedCount">0 connections selected</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="mb-3">Visualizations</h6>
                    <ul class="nav nav-tabs" id="visualizationTabs" role="tablist">
                        ${vizTabs}
                    </ul>
                    <div class="tab-content" id="visualizationTabContent">
                        ${vizContent}
                    </div>
                </div>
            </div>
        `;
        
        // Store connections data for filtering
        window.currentScanConnections = data.connections;
        
        // Add event listeners for checkboxes
        updateSelectedCount();
    })
    .catch(error => {
        modalBody.innerHTML = `<div class="alert alert-danger">Error loading scan details: ${error.message}</div>`;
    });
}


// Filter connections based on anomaly toggle
function filterConnections(scanId) {
    const showOnlyAnomalies = document.getElementById('anomalyFilter').checked;
    const tableBody = document.getElementById('connectionsTableBody');
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const prediction = row.getAttribute('data-prediction');
        if (showOnlyAnomalies) {
            row.style.display = prediction === 'anomaly' ? '' : 'none';
        } else {
            row.style.display = '';
        }
    });
    
    // Reset checkboxes when filtering
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.connection-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

// Toggle select all checkboxes
function toggleSelectAll(scanId) {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.connection-checkbox');
    const visibleCheckboxes = Array.from(checkboxes).filter(cb => 
        cb.closest('tr').style.display !== 'none'
    );
    
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

// Update selected count and extract button state
function updateSelectedCount() {
    // Add event listeners to connection checkboxes
    document.querySelectorAll('.connection-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    const selectedCheckboxes = document.querySelectorAll('.connection-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    document.getElementById('selectedCount').textContent = `${count} connection${count !== 1 ? 's' : ''} selected`;
    document.getElementById('extractBtn').disabled = count === 0;
    
    // Update select all checkbox state
    const allCheckboxes = Array.from(document.querySelectorAll('.connection-checkbox')).filter(cb => 
        cb.closest('tr').style.display !== 'none'
    );
    const checkedBoxes = Array.from(document.querySelectorAll('.connection-checkbox:checked')).filter(cb => 
        cb.closest('tr').style.display !== 'none'
    );
    
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
        selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedBoxes.length === allCheckboxes.length;
    }
}

// Show toast notification
function showToast(message, isSuccess = true) {
    const toast = document.getElementById('extractionToast');
    const toastBody = document.getElementById('toastBody');
    const toastHeader = toast.querySelector('.toast-header');
    const icon = toastHeader.querySelector('i');
    
    // Update toast styling based on success/error
    if (isSuccess) {
        toast.className = 'toast border-success';
        icon.className = 'fas fa-check-circle me-2 text-success';
        toastHeader.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
    } else {
        toast.className = 'toast border-danger';
        icon.className = 'fas fa-exclamation-circle me-2 text-danger';
        toastHeader.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
    }
    
    toastBody.innerHTML = message;
    
    // Show the toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    bsToast.show();
}

// Extract selected connections as separate PCAPs
function extractSelectedConnections(scanId) {
    const selectedCheckboxes = document.querySelectorAll('.connection-checkbox:checked');
    const selectedUIDs = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedUIDs.length === 0) {
        showToast('Please select at least one connection to extract.', false);
        return;
    }
    
    // Show loading state
    const extractBtn = document.getElementById('extractBtn');
    const originalText = extractBtn.innerHTML;
    extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Extracting...';
    extractBtn.disabled = true;
    
    fetch('/api/reports/extract_pcaps', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            scan_id: scanId,
            connection_uids: selectedUIDs
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `Successfully extracted ${data.extracted_count} PCAP file${data.extracted_count !== 1 ? 's' : ''} to:<br><code>${data.output_path}</code>`;
            
            if (data.warnings && data.warnings.length > 0) {
                message += `<br><br><small class="text-warning">Some extractions had warnings - check console for details.</small>`;
                console.warn('Extraction warnings:', data.warnings);
            }
            
            showToast(message, true);
            
            // Reset selections
            document.querySelectorAll('.connection-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
        } else {
            showToast(`Error extracting PCAPs: ${data.error}`, false);
        }
    })
    .catch(error => {
        showToast(`Error extracting PCAPs: ${error.message}`, false);
    })
    .finally(() => {
        extractBtn.innerHTML = originalText;
        extractBtn.disabled = document.querySelectorAll('.connection-checkbox:checked').length === 0;
    });
}

// Auto-refresh every 30 seconds
setInterval(refreshReports, 30000);
</script>
{% endblock %}