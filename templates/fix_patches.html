{% extends "base.html" %}

{% block title %}Fixes and Patches{% endblock %}

{% block extra_css %}
<style>
    .tab-content {
        background-color: #1E1E1E;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .nav-tabs .nav-link {
        background-color: #262730;
        border-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
    }
    
    .nav-tabs .nav-link.active {
        background-color: #00BFFF;
        border-color: #00BFFF;
        color: white !important;
        font-weight: 600;
        z-index: 1;
        position: relative;
    }
    
    .nav-tabs .nav-link.active i {
        color: white !important;
    }
    
    /* Make sure all text in tab content is visible */
    .tab-content *, .tab-content p, .tab-content div, .tab-content span {
        color: #ffffff;
    }

    /* Professional table styling to match reports page */
    .table, .table-sm, #anomalies-table {
        background: #1e1e1e !important;
        border: 2px solid rgba(0, 191, 255, 0.3) !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        color: #ffffff !important;
        --bs-table-bg: #1e1e1e !important;
        --bs-table-color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        margin-bottom: 1rem !important;
    }
    
    .table th, .table-sm th, #anomalies-table th {
        background: rgba(255, 255, 255, 0.03) !important;
        color: #b0b0b0 !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        border-color: rgba(255, 255, 255, 0.12) !important;
        font-size: 0.8rem !important;
        border-bottom: 2px solid #00BFFF !important;
        border-top: none !important;
        border-left: none !important;
        border-right: none !important;
    }
    
    .table td, .table-sm td, #anomalies-table td {
        border-color: rgba(255, 255, 255, 0.12) !important;
        color: #ffffff !important;
        background: #1e1e1e !important;
        border-left: none !important;
        border-right: none !important;
    }
    
    .table tbody tr:hover, .table-sm tbody tr:hover, #anomalies-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02) !important;
    }
    
    .table-responsive {
        border-radius: 8px !important;
        overflow: hidden !important;
        border: 2px solid rgba(0, 191, 255, 0.3) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        background: #1e1e1e !important;
    }
    
    /* Additional table frame styling */
    .table thead th:first-child, .table-sm thead th:first-child, #anomalies-table thead th:first-child {
        border-top-left-radius: 6px !important;
    }
    
    .table thead th:last-child, .table-sm thead th:last-child, #anomalies-table thead th:last-child {
        border-top-right-radius: 6px !important;
    }
    
    .table tbody tr:last-child td:first-child, .table-sm tbody tr:last-child td:first-child, #anomalies-table tbody tr:last-child td:first-child {
        border-bottom-left-radius: 6px !important;
    }
    
    .table tbody tr:last-child td:last-child, .table-sm tbody tr:last-child td:last-child, #anomalies-table tbody tr:last-child td:last-child {
        border-bottom-right-radius: 6px !important;
    }
    
    /* Professional checkbox styling */
    input[type="checkbox"] {
        accent-color: #4CAF50 !important;
        transform: scale(1.1) !important;
    }
    
    /* Badge styling for consistency */
    .badge.bg-danger {
        background: #dc3545 !important;
    }
    
    .badge.bg-warning {
        background: #ffc107 !important;
        color: #000 !important;
    }
    
    .badge.bg-info {
        background: #00BFFF !important;
    }
    
    /* Tooltip styling */
    .tooltip-icon {
        color: #00BFFF;
        cursor: help;
        margin-left: 5px;
        font-size: 0.9em;
    }
    
    .tooltip-icon:hover {
        color: #0099CC;
    }
    
    /* Warning modal styling */
    .warning-modal .modal-header {
        background-color: #dc3545;
        color: white;
    }
    
    .warning-modal .modal-header .btn-close {
        filter: invert(1);
    }
    
    /* Validation alerts */
    .validation-alert {
        border-left: 4px solid #dc3545;
        background: rgba(220, 53, 69, 0.1);
        border-radius: 4px;
        padding: 12px;
        margin: 10px 0;
    }
    
    .validation-alert.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    .validation-alert.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }
    
    /* Training recommendations */
    .recommendation-item {
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid #00BFFF;
    }
    
    .recommendation-item.critical {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }
    
    .recommendation-item.warning {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }
    
    .recommendation-item.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    /* Notification system */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
        max-width: 400px;
    }
    
    .notification {
        background: #1e1e1e;
        border: 1px solid rgba(0, 191, 255, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }
    
    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }
    
    .notification.success {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    .notification.error {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }
    
    .notification.warning {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }
    
    .notification .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .notification .notification-title {
        font-weight: 600;
        color: #ffffff;
    }
    
    .notification .notification-close {
        background: none;
        border: none;
        color: #ffffff;
        cursor: pointer;
        font-size: 18px;
        opacity: 0.7;
    }
    
    .notification .notification-close:hover {
        opacity: 1;
    }
    
    .notification .notification-body {
        color: #ffffff;
        font-size: 14px;
    }
    
    /* Confirmation modal styling */
    .confirmation-modal .modal-content {
        background: #1e1e1e;
        border: 2px solid rgba(0, 191, 255, 0.3);
    }
    
    .confirmation-modal .modal-header {
        background: rgba(0, 191, 255, 0.1);
        border-bottom: 1px solid rgba(0, 191, 255, 0.3);
    }
    
    .confirmation-modal .modal-title {
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-tools me-2"></i>Fixes and Patches
            </h1>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="fixPatchesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ml-training-tab" data-bs-toggle="tab" data-bs-target="#ml-training" type="button" role="tab" aria-controls="ml-training" aria-selected="true">
                        <i class="fas fa-brain me-2"></i>ML Model Training
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vulnerabilities-tab" data-bs-toggle="tab" data-bs-target="#vulnerabilities" type="button" role="tab" aria-controls="vulnerabilities" aria-selected="false">
                        <i class="fas fa-bug me-2"></i>Vulnerability Fixes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-updates-tab" data-bs-toggle="tab" data-bs-target="#system-updates" type="button" role="tab" aria-controls="system-updates" aria-selected="false">
                        <i class="fas fa-download me-2"></i>System Updates
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="config-fixes-tab" data-bs-toggle="tab" data-bs-target="#config-fixes" type="button" role="tab" aria-controls="config-fixes" aria-selected="false">
                        <i class="fas fa-cog me-2"></i>Configuration Fixes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-rec-tab" data-bs-toggle="tab" data-bs-target="#security-rec" type="button" role="tab" aria-controls="security-rec" aria-selected="false">
                        <i class="fas fa-shield-alt me-2"></i>Security Recommendations
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="fixPatchesTabContent">
                <!-- ML Model Training Tab -->
                <div class="tab-pane fade show active" id="ml-training" role="tabpanel" aria-labelledby="ml-training-tab">
                    <div class="mt-4">
                        
                        <!-- AI System Overview -->
                        <div class="alert alert-warning mb-4" role="alert">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Important: Two Different AI Systems</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong><i class="fas fa-search me-1"></i>OneClassSVM (Anomaly Detection)</strong><br>
                                    <small>This page retrains the model that detects "normal vs suspicious" behavior. It uses normal traffic patterns, not manual labels.</small>
                                </div>
                                <div class="col-md-6">
                                    <strong><i class="fas fa-brain me-1"></i>Multi-Class Classifier (Attack Types)</strong><br>
                                    <small>Train this in the <strong>Connection Browser</strong> tab using your manual labels to categorize attack types.</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Overview Section -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-search me-2"></i>OneClassSVM Model Overview</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshModelInfo()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div id="current-model-info">
                                            <p><strong>Current Model:</strong> <span id="model-version">Loading...</span></p>
                                            <p><strong>Training Date:</strong> <span id="model-date">Loading...</span></p>
                                            <p><strong>Training Samples:</strong> <span id="training-samples">Loading...</span></p>
                                            <p><strong>Labeled Anomalies:</strong> <span id="labeled-count">Loading...</span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="model-performance">
                                            <p><strong>Detection Rate:</strong> <span id="detection-rate">Loading...</span></p>
                                            <p><strong>False Positive Rate:</strong> <span id="false-positive-rate">Loading...</span></p>
                                            <p><strong>Model Accuracy:</strong> <span id="model-accuracy">Loading...</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Anomaly Labeling Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tags me-2"></i>Anomaly Labeling & Reinforcement Learning
                                    <i class="fas fa-info-circle tooltip-icon" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="right" 
                                       title="Label detected anomalies to improve model accuracy. Aim for at least 50 labeled samples per attack category for effective training."></i>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="attack-category" class="form-label">
                                            Attack Category
                                            <i class="fas fa-info-circle tooltip-icon" 
                                               data-bs-toggle="tooltip" 
                                               title="Choose the most appropriate attack category. Accurate categorization improves model performance."></i>
                                        </label>
                                        <select class="form-select" id="attack-category">
                                            <option value="">Select attack type...</option>
                                            <option value="brute-force-attack">Brute Force Attack</option>
                                            <option value="port-scan">Port Scan</option>
                                            <option value="ddos-attack">DDoS Attack</option>
                                            <option value="malware-communication">Malware Communication</option>
                                            <option value="data-exfiltration">Data Exfiltration</option>
                                            <option value="lateral-movement">Lateral Movement</option>
                                            <option value="privilege-escalation">Privilege Escalation</option>
                                            <option value="custom-threat">Custom Threat</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="confidence-level" class="form-label">
                                            Confidence Level
                                            <i class="fas fa-info-circle tooltip-icon" 
                                               data-bs-toggle="tooltip" 
                                               title="High confidence (90-100%) should only be used for verified attacks. Medium confidence is recommended for most cases."></i>
                                        </label>
                                        <select class="form-select" id="confidence-level">
                                            <option value="high">High (90-100%)</option>
                                            <option value="medium" selected>Medium (70-89%)</option>
                                            <option value="low">Low (50-69%)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Recent Anomalies Table -->
                                <div class="table-responsive">
                                    <table class="table table-sm" id="anomalies-table">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" id="select-all-anomalies"></th>
                                                <th>Timestamp</th>
                                                <th>Source IP</th>
                                                <th>Destination IP</th>
                                                <th>Anomaly Score</th>
                                                <th>Current Label</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="anomalies-tbody">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading recent anomalies...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary me-2" onclick="labelSelectedAnomalies()">
                                        <i class="fas fa-tag me-1"></i>Label Selected
                                    </button>
                                    <button class="btn btn-success me-2" onclick="startReinforcementTraining()">
                                        <i class="fas fa-play me-1"></i>Start Reinforcement Training
                                    </button>
                                    <button class="btn btn-info" onclick="loadMoreAnomalies()">
                                        <i class="fas fa-plus me-1"></i>Load More
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Retraining Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-sync-alt me-2"></i>OneClassSVM Retraining
                                    <i class="fas fa-info-circle tooltip-icon" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="right" 
                                       title="Creates a new model version using all labeled data. This will replace the current model - ensure you have sufficient labeled data first."></i>
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Training Validation Alerts -->
                                <div id="training-validation-alerts" style="display: none;">
                                    <div id="validation-results" class="mb-3"></div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <p>Retrain the model with all accumulated labeled data and feedback.</p>
                                        <div class="alert alert-warning" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            ‚ö†Ô∏è <strong>Important:</strong> Retraining will create a new model version. Ensure you have sufficient labeled data and consider creating a backup first.
                                        </div>
                                        
                                        <!-- Training Progress Bar -->
                                        <div id="training-progress" class="mb-3" style="display: none;">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" id="training-progress-bar" 
                                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    0%
                                                </div>
                                            </div>
                                            <small class="text-muted" id="training-status">Initializing...</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-info w-100 mb-2" onclick="validateTrainingData()">
                                            <i class="fas fa-check-circle me-2"></i>Validate Training Data
                                        </button>
                                        <button class="btn btn-warning w-100" onclick="startBatchRetraining()">
                                            <i class="fas fa-sync-alt me-2"></i>Start Batch Retraining
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Unknown Categories Management -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-question-circle me-2"></i>Unknown Categories Management
                                    <i class="fas fa-info-circle tooltip-icon" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="right" 
                                       title="Review unknown network protocols, services, and connection patterns detected by the system. Incorporate them carefully to improve detection coverage."></i>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Protocols (<span id="unknown-proto-count">0</span>)</h6>
                                        <div id="unknown-protocols" class="border p-2 mb-3" style="height: 150px; overflow-y: auto;">
                                            Loading...
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Services (<span id="unknown-service-count">0</span>)</h6>
                                        <div id="unknown-services" class="border p-2 mb-3" style="height: 150px; overflow-y: auto;">
                                            Loading...
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>History Patterns (<span id="unknown-history-count">0</span>)</h6>
                                        <div id="unknown-history" class="border p-2 mb-3" style="height: 150px; overflow-y: auto;">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-info" onclick="refreshUnknownCategories()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Categories
                                </button>
                                <button class="btn btn-success" onclick="incorporateUnknownCategories()">
                                    <i class="fas fa-plus me-1"></i>Incorporate New Categories
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vulnerability Fixes Tab -->
                <div class="tab-pane fade" id="vulnerabilities" role="tabpanel" aria-labelledby="vulnerabilities-tab">
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-bug me-2"></i>Vulnerability Fixes</h5>
                        </div>
                        <div class="card-body">
                            <p>Automated vulnerability detection and patching recommendations will be available here.</p>
                            <div class="text-muted">
                                <small>Feature coming soon...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Updates Tab -->
                <div class="tab-pane fade" id="system-updates" role="tabpanel" aria-labelledby="system-updates-tab">
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-download me-2"></i>System Updates</h5>
                        </div>
                        <div class="card-body">
                            <p>System update management and security patch deployment will be managed here.</p>
                            <div class="text-muted">
                                <small>Feature coming soon...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Fixes Tab -->
                <div class="tab-pane fade" id="config-fixes" role="tabpanel" aria-labelledby="config-fixes-tab">
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-cog me-2"></i>Configuration Fixes</h5>
                        </div>
                        <div class="card-body">
                            <p>Automated configuration adjustments and security hardening will be provided here.</p>
                            <div class="text-muted">
                                <small>Feature coming soon...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Recommendations Tab -->
                <div class="tab-pane fade" id="security-rec" role="tabpanel" aria-labelledby="security-rec-tab">
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-shield-alt me-2"></i>Security Recommendations</h5>
                        </div>
                        <div class="card-body">
                            <p>Intelligent security recommendations and best practice guidance will be displayed here.</p>
                            <div class="text-muted">
                                <small>Feature coming soon...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div class="notification-container" id="notification-container"></div>

<!-- Confirmation Modal -->
<div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="fas fa-question-circle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="confirmation-content">
                    <!-- Confirmation content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-action-btn">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Training Validation Modal -->
<div class="modal fade" id="trainingValidationModal" tabindex="-1" aria-labelledby="trainingValidationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainingValidationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Training Data Validation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="validation-details">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>Validating training data...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="proceed-training-btn" style="display: none;" onclick="confirmBatchRetraining()">
                    <i class="fas fa-play me-1"></i>Proceed with Training
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Warning Modal -->
<div class="modal fade warning-modal" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="warningModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Training Warning
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="warning-content">
                    <!-- Warning content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="force-training-btn" onclick="forceBatchRetraining()">
                    <i class="fas fa-exclamation-triangle me-1"></i>Continue Anyway
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Notification system
function showNotification(title, message, type = 'info', duration = 5000) {
    const container = document.getElementById('notification-container');
    const notificationId = 'notification-' + Date.now();
    
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `notification ${type}`;
    
    notification.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">
                <i class="fas fa-${getNotificationIcon(type)} me-2"></i>${title}
            </div>
            <button class="notification-close" onclick="closeNotification('${notificationId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-body">${message}</div>
    `;
    
    container.appendChild(notification);
    
    // Trigger animation
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Auto-remove after duration
    if (duration > 0) {
        setTimeout(() => closeNotification(notificationId), duration);
    }
    
    return notificationId;
}

function getNotificationIcon(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'error': return 'exclamation-circle';
        case 'warning': return 'exclamation-triangle';
        default: return 'info-circle';
    }
}

function closeNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
}

// Confirmation dialog system
function showConfirmation(title, message, confirmText = 'Confirm', confirmClass = 'btn-primary') {
    return new Promise((resolve) => {
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const confirmBtn = document.getElementById('confirm-action-btn');
        
        document.getElementById('confirmationModalLabel').innerHTML = `<i class="fas fa-question-circle me-2"></i>${title}`;
        document.getElementById('confirmation-content').innerHTML = message;
        confirmBtn.textContent = confirmText;
        confirmBtn.className = `btn ${confirmClass}`;
        
        // Remove existing event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        // Add new event listener
        newConfirmBtn.addEventListener('click', () => {
            modal.hide();
            resolve(true);
        });
        
        // Handle modal close
        document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', () => {
            resolve(false);
        }, { once: true });
        
        modal.show();
    });
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    refreshModelInfo();
    loadRecentAnomalies();
    refreshUnknownCategories();
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Model info functions
function refreshModelInfo() {
    fetch('/api/training/model-info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('model-version').textContent = data.version;
                document.getElementById('model-date').textContent = data.training_date;
                document.getElementById('training-samples').textContent = data.training_samples;
                document.getElementById('labeled-count').textContent = data.labeled_count;
                document.getElementById('detection-rate').textContent = data.detection_rate + '%';
                document.getElementById('false-positive-rate').textContent = data.false_positive_rate + '%';
                document.getElementById('model-accuracy').textContent = data.accuracy + '%';
            }
        })
        .catch(error => console.error('Error loading model info:', error));
}

// Anomaly labeling functions
function loadRecentAnomalies() {
    fetch('/api/training/recent-anomalies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateAnomaliesTable(data.anomalies);
            }
        })
        .catch(error => console.error('Error loading anomalies:', error));
}

function updateAnomaliesTable(anomalies) {
    const tbody = document.getElementById('anomalies-tbody');
    if (anomalies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No recent anomalies found</td></tr>';
        return;
    }
    
    tbody.innerHTML = anomalies.map(anomaly => `
        <tr>
            <td><input type="checkbox" class="anomaly-checkbox" value="${anomaly.uid}"></td>
            <td>${anomaly.timestamp}</td>
            <td>${anomaly.source_ip}</td>
            <td>${anomaly.dest_ip}</td>
            <td><span class="badge bg-${anomaly.score > 0.8 ? 'danger' : anomaly.score > 0.6 ? 'warning' : 'info'}">${anomaly.score.toFixed(3)}</span></td>
            <td>${anomaly.current_label || '<span class="text-muted">Unlabeled</span>'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="labelSingleAnomaly('${anomaly.uid}')">
                    <i class="fas fa-tag"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function labelSelectedAnomalies() {
    const selected = Array.from(document.querySelectorAll('.anomaly-checkbox:checked')).map(cb => cb.value);
    const category = document.getElementById('attack-category').value;
    const confidence = document.getElementById('confidence-level').value;
    
    if (selected.length === 0) {
        showNotification('Selection Required', 'Please select at least one anomaly to label', 'warning');
        return;
    }
    
    if (!category) {
        showNotification('Category Required', 'Please select an attack category', 'warning');
        return;
    }
    
    fetch('/api/training/label-anomalies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            anomaly_ids: selected,
            attack_category: category,
            confidence: confidence
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRecentAnomalies();
            refreshModelInfo();
            showNotification('Success', `Successfully labeled ${selected.length} anomalies as ${category}`, 'success');
        } else {
            showNotification('Error', 'Error labeling anomalies: ' + data.error, 'error');
        }
    });
}

function labelSingleAnomaly(uid) {
    const category = document.getElementById('attack-category').value;
    const confidence = document.getElementById('confidence-level').value;
    
    if (!category) {
        showNotification('Category Required', 'Please select an attack category first', 'warning');
        return;
    }
    
    // Simulate selecting this anomaly and call the main function
    const checkboxes = document.querySelectorAll('.anomaly-checkbox');
    checkboxes.forEach(cb => cb.checked = cb.value === uid);
    labelSelectedAnomalies();
}

// Training functions
async function startReinforcementTraining() {
    const confirmed = await showConfirmation(
        'Start Reinforcement Training', 
        'Start reinforcement training with current labeled data? This will improve the model based on your feedback.',
        'Start Training',
        'btn-success'
    );
    
    if (!confirmed) return;
    
    showTrainingProgress();
    
    fetch('/api/training/reinforcement-train', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                pollTrainingProgress(data.task_id);
                showNotification('Training Started', 'Reinforcement training has been started', 'success');
            } else {
                hideTrainingProgress();
                showNotification('Training Error', 'Error starting training: ' + data.error, 'error');
            }
        });
}

// Training validation functions
function validateTrainingData() {
    const modal = new bootstrap.Modal(document.getElementById('trainingValidationModal'));
    modal.show();
    
    fetch('/api/training/validate-data')
        .then(response => response.json())
        .then(data => {
            displayValidationResults(data);
        })
        .catch(error => {
            console.error('Validation error:', error);
            document.getElementById('validation-details').innerHTML = 
                '<div class="alert alert-danger">Error validating training data: ' + error + '</div>';
        });
}

function displayValidationResults(validation) {
    const detailsDiv = document.getElementById('validation-details');
    const proceedBtn = document.getElementById('proceed-training-btn');
    
    let html = '';
    
    // Overall status
    if (validation.is_valid) {
        html += '<div class="validation-alert success"><i class="fas fa-check-circle me-2"></i><strong>Validation Passed</strong> - Training data is ready for model retraining.</div>';
        proceedBtn.style.display = 'block';
    } else {
        html += '<div class="validation-alert"><i class="fas fa-exclamation-circle me-2"></i><strong>Validation Issues Found</strong> - Review the issues below before training.</div>';
        if (validation.training_recommended) {
            proceedBtn.style.display = 'block';
            proceedBtn.className = 'btn btn-warning';
            proceedBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Proceed with Caution';
        }
    }
    
    // Sample count
    html += `<div class="mt-3"><h6>Training Data Summary</h6>`;
    html += `<p><strong>Total labeled samples:</strong> ${validation.total_samples || 0}</p>`;
    
    // Attack categories
    if (validation.attack_categories) {
        html += '<p><strong>Attack categories:</strong></p><ul>';
        for (const [category, count] of Object.entries(validation.attack_categories)) {
            html += `<li>${category}: ${count} samples</li>`;
        }
        html += '</ul>';
    }
    
    // Recommendations
    if (validation.recommendations && validation.recommendations.length > 0) {
        html += '<h6>Recommendations</h6>';
        validation.recommendations.forEach(rec => {
            let cssClass = 'recommendation-item';
            if (rec.includes('üî¥') || rec.includes('Critical')) cssClass += ' critical';
            else if (rec.includes('üü°') || rec.includes('Warning')) cssClass += ' warning';
            else if (rec.includes('‚úÖ') || rec.includes('Good')) cssClass += ' success';
            
            html += `<div class="${cssClass}">${rec}</div>`;
        });
    }
    
    // Data quality issues
    if (validation.data_quality_issues && validation.data_quality_issues.length > 0) {
        html += '<h6 class="mt-3">Data Quality Issues</h6>';
        validation.data_quality_issues.forEach(issue => {
            html += `<div class="validation-alert"><i class="fas fa-exclamation-triangle me-2"></i>${issue}</div>`;
        });
    }
    
    detailsDiv.innerHTML = html;
}

async function startBatchRetraining() {
    // First validate training data
    try {
        const response = await fetch('/api/training/validate-data');
        const validation = await response.json();
        
        if (validation.risk_level === 'high' || !validation.training_recommended) {
            showTrainingWarning(validation);
        } else if (validation.risk_level === 'medium') {
            const recommendations = validation.recommendations.slice(0, 3).join('<br>‚Ä¢ ');
            const confirmed = await showConfirmation(
                'Training Data Issues Detected',
                `‚ö†Ô∏è Training data has some issues but training can proceed.<br><br><strong>Recommendations:</strong><br>‚Ä¢ ${recommendations}<br><br>Continue with training?`,
                'Continue Training',
                'btn-warning'
            );
            
            if (confirmed) {
                confirmBatchRetraining();
            }
        } else {
            const confirmed = await showConfirmation(
                'Start Batch Retraining',
                'This will create a new model version using all labeled data. The process may take several minutes.',
                'Start Retraining',
                'btn-warning'
            );
            
            if (confirmed) {
                confirmBatchRetraining();
            }
        }
    } catch (error) {
        console.error('Validation error:', error);
        const confirmed = await showConfirmation(
            'Validation Error',
            'Unable to validate training data. This might indicate system issues.<br><br>Continue with training anyway?',
            'Continue Anyway',
            'btn-danger'
        );
        
        if (confirmed) {
            confirmBatchRetraining();
        }
    }
}

function showTrainingWarning(validation) {
    const modal = new bootstrap.Modal(document.getElementById('warningModal'));
    const warningContent = document.getElementById('warning-content');
    
    let html = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>';
    html += '<strong>High Risk Training Detected</strong></div>';
    
    html += '<p>Training is not recommended due to the following issues:</p><ul>';
    
    if (validation.total_samples < 50) {
        html += '<li>Insufficient labeled samples (minimum 50 recommended)</li>';
    }
    
    if (validation.data_quality_issues) {
        validation.data_quality_issues.forEach(issue => {
            html += `<li>${issue}</li>`;
        });
    }
    
    html += '</ul>';
    html += '<p><strong>Recommendations:</strong></p><ul>';
    validation.recommendations.slice(0, 5).forEach(rec => {
        html += `<li>${rec.replace(/[üî¥üü°‚úÖ‚ö†Ô∏è]/g, '').trim()}</li>`;
    });
    html += '</ul>';
    
    html += '<p class="text-warning"><strong>Warning:</strong> Training with insufficient or poor quality data may degrade model performance.</p>';
    
    warningContent.innerHTML = html;
    modal.show();
}

function confirmBatchRetraining() {
    // Close any open modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) modalInstance.hide();
    });
    
    showTrainingProgress();
    
    fetch('/api/training/batch-retrain', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                pollTrainingProgress(data.task_id);
            } else {
                hideTrainingProgress();
                showNotification('Training Error', 'Error starting batch retraining: ' + data.error, 'error');
            }
        });
}

function forceBatchRetraining() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('warningModal'));
    modal.hide();
    confirmBatchRetraining();
}

function showTrainingProgress() {
    document.getElementById('training-progress').style.display = 'block';
    updateTrainingProgress(0, 'Initializing...');
}

function hideTrainingProgress() {
    document.getElementById('training-progress').style.display = 'none';
}

function updateTrainingProgress(percent, status) {
    const progressBar = document.getElementById('training-progress-bar');
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    progressBar.textContent = percent + '%';
    document.getElementById('training-status').textContent = status;
}

function pollTrainingProgress(taskId) {
    const poll = setInterval(() => {
        fetch(`/api/training/progress/${taskId}`)
            .then(response => response.json())
            .then(data => {
                updateTrainingProgress(data.progress, data.status);
                
                if (data.completed) {
                    clearInterval(poll);
                    hideTrainingProgress();
                    refreshModelInfo();
                    if (data.success) {
                        showNotification('Training Complete', 'Training completed successfully!', 'success');
                    } else {
                        showNotification('Training Failed', 'Training failed: ' + data.error, 'error');
                    }
                }
            });
    }, 1000);
}

// Unknown categories functions
function refreshUnknownCategories() {
    fetch('/api/training/unknown-categories')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateUnknownCategoriesDisplay(data.categories);
            }
        })
        .catch(error => console.error('Error loading unknown categories:', error));
}

function updateUnknownCategoriesDisplay(categories) {
    document.getElementById('unknown-proto-count').textContent = categories.proto.length;
    document.getElementById('unknown-service-count').textContent = categories.service.length;
    document.getElementById('unknown-history-count').textContent = categories.history.length;
    
    document.getElementById('unknown-protocols').innerHTML = 
        categories.proto.map(p => `<span class="badge bg-secondary me-1 mb-1">${p}</span>`).join('');
    document.getElementById('unknown-services').innerHTML = 
        categories.service.map(s => `<span class="badge bg-secondary me-1 mb-1">${s}</span>`).join('');
    document.getElementById('unknown-history').innerHTML = 
        categories.history.slice(0, 20).map(h => `<span class="badge bg-secondary me-1 mb-1">${h}</span>`).join('') +
        (categories.history.length > 20 ? `<span class="text-muted">... and ${categories.history.length - 20} more</span>` : '');
}

async function incorporateUnknownCategories() {
    const confirmed = await showConfirmation(
        'Incorporate Unknown Categories',
        'Incorporate all unknown categories into the model? This will trigger a model update and may affect detection accuracy.',
        'Incorporate Categories',
        'btn-warning'
    );
    
    if (!confirmed) return;
    
    fetch('/api/training/incorporate-unknown', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshUnknownCategories();
                refreshModelInfo();
                showNotification('Categories Incorporated', 'Unknown categories incorporated successfully!', 'success');
            } else {
                showNotification('Incorporation Error', 'Error incorporating categories: ' + data.error, 'error');
            }
        });
}

// Utility functions
function loadMoreAnomalies() {
    // Implementation for pagination
    loadRecentAnomalies();
}

// Select all checkbox functionality
document.addEventListener('change', function(e) {
    if (e.target.id === 'select-all-anomalies') {
        const checkboxes = document.querySelectorAll('.anomaly-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    }
});
</script>
{% endblock %}